{% extends "layout.html" %}

{% block title %}Reportes de Producción{% endblock %}
{% block page_header %}Análisis de Datos de Producción{% endblock %}

{% block content %}

<!-- 
  Este contenedor principal ahora pasa todos los datos necesarios
  al archivo JS externo a través de atributos data-*.
-->
<div id="reports-container"
    data-weekly-data='{{ weekly_data | tojson }}'
    data-monthly-data='{{ monthly_data | tojson }}'
    data-area-weekly-data='{{ area_weekly_data | tojson }}'
    data-area-monthly-data='{{ area_monthly_data | tojson }}'
    data-range-chart-data='{{ (range_data.chart if range_data else none) | tojson }}'
    data-comparison-chart-data='{{ (comparison_data.chart if comparison_data else none) | tojson }}'
    data-areas-ihp='{{ AREAS_IHP | tojson }}'
    data-areas-fhp='{{ AREAS_FHP | tojson }}'
    data-selected-area='{{ selected_area }}'
>
    <!-- SECCIÓN DE FILTROS DINÁMICOS -->
    <div class="content-section">
        <form id="reportForm" method="GET" action="{{ url_for('production.reportes') }}">
            <div class="row align-items-end">
                <!-- Columna para Selectores Principales -->
                <div class="col-lg-5 col-md-12">
                    <div class="form-row">
                        <div id="group_selector_container" class="form-group col-sm-6">
                            <label for="group">Grupo:</label>
                            <select id="group" name="group" class="form-control" {% if not is_admin %}disabled{% endif %}>
                                <option value="IHP" {% if group == 'IHP' %}selected{% endif %}>IHP</option>
                                <option value="FHP" {% if group == 'FHP' %}selected{% endif %}>FHP</option>
                            </select>
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="report_type">Tipo de Análisis:</label>
                            <select id="report_type" name="report_type" class="form-control">
                                <option value="single_day" {% if report_type == 'single_day' %}selected{% endif %}>Análisis de un Día</option>
                                <option value="area_analysis" {% if report_type == 'area_analysis' %}selected{% endif %}>Análisis por Área</option>
                                <option value="date_range" {% if report_type == 'date_range' %}selected{% endif %}>Rendimiento de Grupo</option>
                                <option value="group_comparison" {% if report_type == 'group_comparison' %}selected{% endif %}>Comparar Grupos (IHP vs FHP)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Columna para los Inputs de Fecha y Área -->
                <div class="col-lg-5 col-md-12">
                    <div class="form-row">
                        <div id="single_day_inputs" class="form-group col-sm-6" style="display:none;">
                            <label for="single_date">Seleccionar Día:</label>
                            <input type="date" class="form-control" id="single_date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div id="area_selector_container" class="form-group col-sm-6" style="display:none;">
                            <label for="area_selector">Área:</label>
                            <select id="area_selector" name="area" class="form-control"></select>
                        </div>
                        <div id="date_range_inputs" class="form-row col-12" style="display:none;">
                            <div class="form-group col-sm-6"><label for="range_start_date">Desde:</label><input type="date" class="form-control" id="range_start_date" name="start_date_range" value="{{ start_date }}"></div>
                            <div class="form-group col-sm-6"><label for="range_end_date">Hasta:</label><input type="date" class="form-control" id="range_end_date" name="end_date" value="{{ end_date }}"></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-2 col-md-12 mt-3 mt-lg-0">
                    <div class="form-group"><button type="submit" class="btn btn-primary btn-block"><i class="fas fa-chart-line"></i> Generar</button></div>
                </div>
            </div>
        </form>
    </div>

    <!-- CONTENIDO CONDICIONAL DEL REPORTE (Sin cambios en esta sección) -->
    {% if report_type == 'single_day' and weekly_data and monthly_data %}
    <h3 class="mt-5 mb-3">Análisis para el día: <strong>{{ start_date }}</strong></h3>
    <div class="row">
        <div class="col-lg-6 mb-4"><div class="content-section h-100"><h4 class="mb-3">Contexto Semanal</h4><div style="height: 350px;"><canvas id="weeklyChart"></canvas></div></div></div>
        <div class="col-lg-6 mb-4"><div class="content-section h-100"><h4 class="mb-3">Contexto Mensual</h4><div style="height: 350px;"><canvas id="monthlyChart"></canvas></div></div></div>
    </div>
    {% endif %}

    {% if report_type == 'area_analysis' and area_weekly_data and area_monthly_data %}
    <h3 class="mt-5 mb-3">Análisis por Área: <strong>{{ selected_area }}</strong> ({{ group }}) para el día: <strong>{{ start_date }}</strong></h3>
    <div class="row">
        <div class="col-lg-6 mb-4"><div class="content-section h-100"><h4 class="mb-3">Contexto Semanal del Área</h4><div style="height: 350px;"><canvas id="areaWeeklyChart"></canvas></div></div></div>
        <div class="col-lg-6 mb-4"><div class="content-section h-100"><h4 class="mb-3">Contexto Mensual del Área</h4><div style="height: 350px;"><canvas id="areaMonthlyChart"></canvas></div></div></div>
    </div>
    {% endif %}

    {% if report_type == 'date_range' and range_data %}
    <h3 class="mt-5 mb-3">Análisis del rango: <strong>{{ start_date }}</strong> al <strong>{{ end_date }}</strong></h3>
    <!-- Contenido del reporte por rango... -->
    {% endif %}

    {% if report_type == 'group_comparison' and comparison_data %}
    <h3 class="mt-5 mb-3">Comparación IHP vs. FHP del <strong>{{ start_date }}</strong> al <strong>{{ end_date }}</strong></h3>
    <!-- Contenido del reporte de comparación... -->
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/reportes.js') }}"></script>
{% endblock %}